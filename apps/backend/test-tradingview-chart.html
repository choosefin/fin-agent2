<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Chart Integration Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"] {
            flex: 1;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .chart-output {
            margin-top: 20px;
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
        }
        .api-response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .endpoint-url {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TradingView Chart Integration Test</h1>

        <!-- Test 1: Symbol Chart Response -->
        <div class="test-section">
            <h2>1. Symbol Chart Response API (/api/symbol-chart)</h2>
            <p>Enter a query mentioning a stock symbol, and get an embeddable chart</p>
            <div class="endpoint-url">POST http://localhost:5173/api/symbol-chart</div>
            <div class="input-group">
                <input type="text" id="query-input" placeholder="e.g., Show me AAPL chart" value="Show me AAPL chart">
                <select id="theme-select">
                    <option value="light">Light Theme</option>
                    <option value="dark">Dark Theme</option>
                </select>
                <button onclick="testSymbolChart()">Get Chart</button>
            </div>
            <div id="symbol-chart-output" class="chart-output"></div>
            <div id="symbol-response" class="api-response" style="display:none;"></div>
        </div>

        <!-- Test 2: TradingView Widget API -->
        <div class="test-section">
            <h2>2. TradingView Chart API (/api/tradingview-chart)</h2>
            <p>Direct chart widget generation with customizable options</p>
            <div class="endpoint-url">POST http://localhost:5173/api/tradingview-chart</div>
            <div class="input-group">
                <input type="text" id="symbol-input" placeholder="Symbol (e.g., TSLA)" value="TSLA">
                <select id="embed-type">
                    <option value="widget">Widget</option>
                    <option value="iframe">iFrame</option>
                    <option value="config">Config Only</option>
                </select>
                <select id="interval-select">
                    <option value="1">1 minute</option>
                    <option value="5">5 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="1D" selected>1 day</option>
                    <option value="1W">1 week</option>
                </select>
                <button onclick="testTradingViewChart()">Generate Chart</button>
            </div>
            <div id="tradingview-output" class="chart-output"></div>
            <div id="tradingview-response" class="api-response" style="display:none;"></div>
        </div>

        <!-- Test 3: Quick Chart -->
        <div class="test-section">
            <h2>3. Quick Chart API (/api/chart/:symbol)</h2>
            <p>Direct URL access to full-page charts</p>
            <div class="endpoint-url">GET http://localhost:5173/api/chart/:symbol</div>
            <div class="input-group">
                <input type="text" id="quick-symbol" placeholder="Symbol" value="GOOGL">
                <button onclick="testQuickChart()">Open Chart</button>
                <button onclick="embedQuickChart()">Embed Chart</button>
            </div>
            <iframe id="quick-chart-frame" style="width:100%;height:600px;border:1px solid #ddd;border-radius:4px;display:none;margin-top:15px;"></iframe>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5173';

        async function testSymbolChart() {
            const query = document.getElementById('query-input').value;
            const theme = document.getElementById('theme-select').value;
            
            const outputDiv = document.getElementById('symbol-chart-output');
            const responseDiv = document.getElementById('symbol-response');
            
            outputDiv.innerHTML = '<p>Loading chart...</p>';
            responseDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/symbol-chart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        preferences: { theme }
                    })
                });

                const data = await response.json();
                
                if (data.success && data.chart && data.chart.html) {
                    outputDiv.innerHTML = data.chart.html;
                    
                    // Execute any scripts in the HTML
                    const scripts = outputDiv.getElementsByTagName('script');
                    for (let script of scripts) {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        script.parentNode.replaceChild(newScript, script);
                    }
                } else {
                    outputDiv.innerHTML = `<p style="color:red;">Error: ${data.message || 'Failed to generate chart'}</p>`;
                }
                
                responseDiv.textContent = JSON.stringify(data, null, 2);
                responseDiv.style.display = 'block';
            } catch (error) {
                outputDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                responseDiv.textContent = `Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        async function testTradingViewChart() {
            const symbol = document.getElementById('symbol-input').value;
            const embedType = document.getElementById('embed-type').value;
            const interval = document.getElementById('interval-select').value;
            const theme = document.getElementById('theme-select').value;
            
            const outputDiv = document.getElementById('tradingview-output');
            const responseDiv = document.getElementById('tradingview-response');
            
            outputDiv.innerHTML = '<p>Loading chart...</p>';
            responseDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/tradingview-chart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        embedType,
                        interval,
                        theme,
                        height: 500
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    if (embedType === 'config') {
                        outputDiv.innerHTML = `<pre>${JSON.stringify(data.config, null, 2)}</pre>`;
                    } else if (data.html) {
                        outputDiv.innerHTML = data.html;
                        
                        // Execute scripts
                        const scripts = outputDiv.getElementsByTagName('script');
                        for (let script of scripts) {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.textContent = script.textContent;
                            }
                            script.parentNode.replaceChild(newScript, script);
                        }
                    }
                } else {
                    outputDiv.innerHTML = `<p style="color:red;">Error: ${data.message || 'Failed to generate chart'}</p>`;
                }
                
                responseDiv.textContent = JSON.stringify(data, null, 2);
                responseDiv.style.display = 'block';
            } catch (error) {
                outputDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                responseDiv.textContent = `Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        function testQuickChart() {
            const symbol = document.getElementById('quick-symbol').value;
            const theme = document.getElementById('theme-select').value;
            const url = `${API_BASE}/api/chart/${symbol}?theme=${theme}`;
            window.open(url, '_blank');
        }

        function embedQuickChart() {
            const symbol = document.getElementById('quick-symbol').value;
            const theme = document.getElementById('theme-select').value;
            const frame = document.getElementById('quick-chart-frame');
            frame.src = `${API_BASE}/api/chart/${symbol}?theme=${theme}`;
            frame.style.display = 'block';
        }
    </script>
</body>
</html>