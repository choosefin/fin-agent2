# Azure App Service Compatible Dockerfile for Motia
# Uses Node.js base with Python support for multi-language capabilities
FROM node:20-bullseye

# Install Python and system dependencies for Motia
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    build-essential \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Create Python symlinks for Motia compatibility
RUN ln -sf /usr/bin/python3 /usr/bin/python && \
    ln -sf /usr/bin/pip3 /usr/bin/pip

# Set up working directory
WORKDIR /home/site/wwwroot

# Copy package files first for better caching
COPY package*.json ./
COPY motia-workbench.json ./
COPY motia.cloud.json ./

# Install Node dependencies
RUN npm ci --only=production

# Copy application code
COPY . .

# Install Motia CLI globally for Azure
RUN npm install -g motia@0.6.4-beta.130

# Set up Python virtual environment for Motia steps
RUN python3 -m venv /home/site/wwwroot/python_modules

# Build Motia project
RUN motia build

# Azure App Service specific settings
ENV PORT=8080
ENV WEBSITES_PORT=8080
ENV NODE_ENV=production

# Create startup script for Azure App Service
RUN echo '#!/bin/bash\n\
echo "Starting Motia on Azure App Service..."\n\
echo "Node version: $(node --version)"\n\
echo "Python version: $(python3 --version)"\n\
echo "Motia version: $(motia --version)"\n\
echo "Port: $PORT"\n\
\n\
# Activate Python virtual environment if needed\n\
if [ -d "/home/site/wwwroot/python_modules" ]; then\n\
    source /home/site/wwwroot/python_modules/bin/activate\n\
fi\n\
\n\
# Start Motia server\n\
exec motia start --port $PORT --host 0.0.0.0\n\
' > /home/site/wwwroot/startup.sh && chmod +x /home/site/wwwroot/startup.sh

# Azure App Service expects the app to listen on port 8080
EXPOSE 8080

# Use the startup script
CMD ["/home/site/wwwroot/startup.sh"]